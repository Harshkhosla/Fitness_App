generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}


model User {
  id      String         @id @default(auto()) @map("_id") @db.ObjectId
  email   String         @unique
  name    String?
  password String
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  websites  Website[]    @relation("UserWebsites")
  userDetails UserDetails?  @relation("UserDetails")
  userDetailsFilled Boolean?
  userDemoGraphs UserDemoGraph[] @relation("UserDemoGraphs")
  mealPlans         MealPlan[]
  chatHistory       ChatHistory[]
  weightHistory     WeightHistory[]

  // use explicit relation through UserRegion
  regions UserRegion[]
}

model MealPlan {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  userId         String      @db.ObjectId
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  generatedAt    DateTime    @default(now())
  numberOfDays   Int         @default(7)
  isActive       Boolean     @default(true)
  userInput      Json
  mealStructure  Json
  days           MealDay[]
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  
  @@index([userId, isActive])
}

model MealDay {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  mealPlanId String   @db.ObjectId
  mealPlan   MealPlan @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  date       DateTime
  meals      Meal[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([mealPlanId, date])
}

model Meal {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  mealDayId       String      @db.ObjectId
  mealDay         MealDay     @relation(fields: [mealDayId], references: [id], onDelete: Cascade)
  externalId      String
  name            String
  type            String
  calories        Int
  protein         Float
  carbs           Float
  fats            Float
  time            String
  isCompleted     Boolean     @default(false)
  completedAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@index([mealDayId, type])
}

model ChatHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      String
  content   Json
  metadata  Json?
  createdAt DateTime @default(now())
  
  @@index([userId, createdAt])
}

model WeightHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime
  weight    Float
  goal      Float?
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, date])
}

model UserDetails {
  id    String @id @default(auto()) @map("_id") @db.ObjectId
  owner       User     @relation("UserDetails", fields: [ownerId], references: [id])
  age     Int
  weight Int
  height  Int
  goalWeight  Int?
  bmi  Int
  preferences String 
  ownerId     String @unique @db.ObjectId
}

model UserDemoGraph{
  id String @id @default(auto()) @map("_id") @db.ObjectId
  owner       User     @relation("UserDemoGraphs", fields: [ownerId], references: [id])
  progress String 
  ownerId String @db.ObjectId
}
model NotificationPreference {
  id          String  @id @default(auto()) @map("_id") @db.ObjectId
  notifyCall  Boolean @default(false)
  notifySMS   Boolean @default(false)
  notifyEmail Boolean @default(false)
  notifyPush  Boolean @default(false)
  websites    Website[]
}

model Website{
  id  String @id @default(auto()) @map("_id") @db.ObjectId
  url String
  timeAdded DateTime
  uptime DateTime?
  incident Int?@default(0)
  websiteStatus WebsiteStatus[]
  alert  String?
  acknowledge       String?
  escalationPolicy  String?
  notificationPref  NotificationPreference? @relation(fields: [notificationPrefId], references: [id])
  notificationPrefId String? @db.ObjectId
  owner       User      @relation("UserWebsites", fields: [ownerId], references: [id])
  ownerId     String @db.ObjectId
}
model WebsiteStatus{
   id  String @id @default(auto()) @map("_id") @db.ObjectId
   responseTime  Int
   statusCheck statusCheck
   region Region @relation(fields: [regionId],references: [id])
   regionId String @db.ObjectId
   website Website @relation(fields: [websiteId],references: [id])
   websiteId String @db.ObjectId
   timestamp DateTime?
}

model Region {
  id    String           @id @default(auto()) @map("_id") @db.ObjectId
  name  String
  websiteStatuses WebsiteStatus[]
  users   UserRegion[]    // explicit relation through UserRegion
}

model UserRegion {
  id       String   @id @default(auto()) @map("_id") @db.ObjectId
  userId   String   @db.ObjectId
  regionId String   @db.ObjectId

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  region Region @relation(fields: [regionId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, regionId])
  @@index([userId])
  @@index([regionId])
}

enum statusCheck{
  Up
  DOWN
  UNKNONE
}